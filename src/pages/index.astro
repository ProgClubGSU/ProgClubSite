---
import { getEvents, renderPortableText } from "@/lib/sanity.js";
import Hero from "@/components/Hero.astro";
import Breadcrumb from "@/components/Breadcrumb.astro";
import Section from "@/components/Section.astro";
import BlogPostCard from "@/components/BlogPostCard.astro";
import Layout from "@/layouts/Layout.astro";
import { KNOWN_TECH, ABOUT_ME, SITE_TITLE } from "@/consts";
import { separateEventsByDisplayType, sortEventsByPriority, type Event } from "@/utils/eventUtils";

const rawEvents = await getEvents();

// Helper function to extract plain text from description
function getPlainTextExcerpt(description) {
  if (typeof description === 'string') return description;
  if (!description || !Array.isArray(description)) return '';
  
  // Extract text from block content
  return description
    .filter(block => block._type === 'block')
    .map(block => 
      block.children
        ?.filter(child => child._type === 'span')
        ?.map(span => span.text)
        ?.join('') || ''
    )
    .join(' ')
    .substring(0, 150) + '...';
}

// Helper function to determine event status
function getEventStatus(date) {
  if (!date) return 'upcoming';
  
  const now = new Date();
  const eventDate = new Date(date);
  
  // Set event date to start of day for comparison
  eventDate.setHours(0, 0, 0, 0);
  const today = new Date(now);
  today.setHours(0, 0, 0, 0);
  
  if (eventDate < today) return 'past';
  if (eventDate.getTime() === today.getTime()) return 'active';
  return 'upcoming';
}

// Convert raw events to Event type and sort by priority
const events: Event[] = rawEvents.map(event => ({
  ...event,
  slug: { current: event.slug.current }
}));

const sortedEvents = sortEventsByPriority(events);

// Get only featured and upcoming events (no past events)
const { fullCardEvents, liteCardEvents } = separateEventsByDisplayType(sortedEvents);

// Combine and limit to 3 events for home page (more minimal)
const homePageEvents = [...fullCardEvents, ...liteCardEvents].slice(0, 3);
---

<Layout title={SITE_TITLE}>
  <Hero />
  
  <!-- Our Mission Section -->
  <section class="py-20 px-8 bg-black relative overflow-hidden">
    <!-- Continuing grid background with fade-in effect -->
    <div class="absolute inset-0">
      <div class="w-full h-full opacity-3" style="background-image: linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 50px 50px;"></div>
      <!-- Fade-in gradient at top -->
      <div class="absolute top-0 left-0 right-0 h-32 bg-gradient-to-b from-black via-black/80 to-transparent"></div>
    </div>
    
    <div class="max-w-6xl mx-auto relative z-10">
      <!-- Section Title -->
      <div class="mb-16">
        <h2 class="text-4xl md:text-6xl font-bold text-white mb-4" style="font-family: 'Helvetica Neue', sans-serif;">
          Our Mission
        </h2>
        <div class="w-20 h-1 bg-white/20"></div>
      </div>
      
      <!-- Mission Content -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-16 items-center">
        <!-- Left Side - Mission Text -->
        <div class="space-y-8">
          <div class="space-y-6">
            <p class="text-xl md:text-2xl text-white/90 leading-relaxed" style="font-family: 'Helvetica Neue', sans-serif;">
              We're building the next generation of <span class="text-white font-semibold">creators</span>, <span class="text-white font-semibold">innovators</span>, and <span class="text-white font-semibold">problem solvers</span> at Georgia State University.
            </p>
            
            <p class="text-lg md:text-xl text-white/70 leading-relaxed" style="font-family: 'Helvetica Neue', sans-serif;">
              Through hands-on workshops, collaborative projects, and a supportive community, we empower students to transform ideas into reality and shape the future of technology.
            </p>
          </div>
          
          <!-- Mission Values -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-12">
            <div class="text-center md:text-left">
              <div class="text-2xl font-bold text-white mb-2" style="font-family: 'Helvetica Neue', sans-serif;">Learn</div>
              <div class="text-sm text-white/60 uppercase tracking-wider" style="font-family: 'Helvetica Neue', sans-serif;">Master new technologies</div>
            </div>
            <div class="text-center md:text-left">
              <div class="text-2xl font-bold text-white mb-2" style="font-family: 'Helvetica Neue', sans-serif;">Build</div>
              <div class="text-sm text-white/60 uppercase tracking-wider" style="font-family: 'Helvetica Neue', sans-serif;">Create meaningful projects</div>
            </div>
            <div class="text-center md:text-left">
              <div class="text-2xl font-bold text-white mb-2" style="font-family: 'Helvetica Neue', sans-serif;">Connect</div>
              <div class="text-sm text-white/60 uppercase tracking-wider" style="font-family: 'Helvetica Neue', sans-serif;">Join our community</div>
            </div>
          </div>
        </div>
        
        <!-- Right Side - Visual Element -->
        <div class="relative">
          <!-- Large decorative number -->
          <div class="text-[12rem] md:text-[16rem] font-bold text-white/5 absolute -top-20 -right-10 select-none" style="font-family: 'Helvetica Neue', sans-serif;">
            01
          </div>
          
          <!-- Stats or highlight boxes -->
          <div class="relative z-10 space-y-6">
            <div class="bg-white/5 border border-white/10 p-6 rounded-lg backdrop-blur-sm">
              <div class="text-3xl font-bold text-white mb-2" style="font-family: 'Helvetica Neue', sans-serif;">500+</div>
              <div class="text-white/70" style="font-family: 'Helvetica Neue', sans-serif;">Students Empowered</div>
            </div>
            
            <div class="bg-white/5 border border-white/10 p-6 rounded-lg backdrop-blur-sm">
              <div class="text-3xl font-bold text-white mb-2" style="font-family: 'Helvetica Neue', sans-serif;">100+</div>
              <div class="text-white/70" style="font-family: 'Helvetica Neue', sans-serif;">Projects Built</div>
            </div>
            
            <div class="bg-white/5 border border-white/10 p-6 rounded-lg backdrop-blur-sm">
              <div class="text-3xl font-bold text-white mb-2" style="font-family: 'Helvetica Neue', sans-serif;">24/7</div>
              <div class="text-white/70" style="font-family: 'Helvetica Neue', sans-serif;">Community Support</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  
  <Section
    title="Events"
    className={"bg-gradient-to-b from-black/70 from-[5%] to-black via-black"}
  >
    {homePageEvents.length > 0 ? (
      <div class="w-full grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto">
        {
          homePageEvents.map((event) => {
            const eventDate = event.date?.isTBD ? null : (event.date?.value ? new Date(event.date.value) : null);
            return (
              <BlogPostCard
                slug={event.slug.current}
                title={event.title}
                excerpt={getPlainTextExcerpt(event.description)}
                date={eventDate}
                time={event.time?.isTBD ? null : event.time?.value}
                location={event.location?.isTBD ? null : event.location?.value}
                status={getEventStatus(eventDate)}
                pinned={event.pinned || false}
                specialTags={event.specialTags || []}
                resources={event.resources}
              />
            );
          })
        }
      </div>
    ) : (
      <div class="text-center py-12">
        <p class="text-white/60 text-lg">No upcoming events at the moment. Check back soon!</p>
      </div>
    )}
    <div class="w-full flex justify-center mt-6">
      <a 
        href="/events" 
        class="inline-flex items-center px-6 py-3 text-white font-medium rounded-lg transition-all duration-300 hover:scale-105 group border border-white/20 bg-white/[0.05] hover:bg-white/[0.1] hover:border-white/40"
      >
        <span class="mr-2 text-green-400 group-hover:text-green-300 transition-colors duration-300">‚ùØ</span>
        <span class="group-hover:text-green-100 transition-colors duration-300">See All Events</span>
      </a>
    </div>
  </Section>
  {/* Technologies section - commented out for now, may be used in the future */}
  {/* <Section title="Technologies I Know" full_screen={false}>
    <div class="w-full grid place-items-center">
      <div
        class="w-full gap-4 flex flex-wrap px-3 max-w-xl text-lg justify-center"
      >
        {KNOWN_TECH.map((x) => <Breadcrumb title={x} />)}
      </div>
    </div>
  </Section> */}
  <Section title="About">
    <div class="w-full grid place-items-center">
      <div
        class="max-w-4xl text-xl md:text-lg opacity-90 text-center justify-evenly"
      >
        <p>{ABOUT_ME}</p>
      </div>
    </div>
  </Section>
</Layout>
